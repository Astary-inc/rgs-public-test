(function(){"use strict";const n={DEFAULT_TIMEOUT:1e4,VIDEO_HEIGHT_RATIO:.24,PLAYER_WIDTH:640,PLAYER_HEIGHT:360,ERROR_RETURN_VALUE:-1,ASPECT_RATIO:{WIDTH:9,HEIGHT:16},UNITY_CONTAINER_MAX_WIDTH:null,ANIMATION:{POPUP_DURATION:600,TRANSITION_DURATION:800,POPUP_SCALE_START:.3,CENTERED_SIZE_RATIO:.8,EASING_POPUP:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",EASING_TRANSITION:"cubic-bezier(0.4, 0.0, 0.2, 1)"}},i=Object.freeze({SUCCESS:"success",ERROR:"error"}),R={[-1]:"UNSTARTED",0:"ENDED",1:"PLAYING",2:"PAUSED",3:"BUFFERING",5:"CUED"};function m(o){switch(o){case 2:return"INVALID_PARAMETER";case 5:return"HTML5_ERROR";case 100:return"VIDEO_NOT_FOUND";case 101:case 150:return"EMBED_NOT_ALLOWED";default:return"UNKNOWN_ERROR"}}function T(o){return R[o]||"UNKNOWN"}class P{constructor(){this.stateChangeListeners=[],this.errorListeners=[],this.unityGameObjectName=null}dispatchStateChange(e){this.sendStateChangeToUnity(e.data),[...this.stateChangeListeners].forEach(t=>{t(e)})}dispatchError(e){[...this.errorListeners].forEach(t=>{t(e)})}addStateChangeListener(e){this.stateChangeListeners.push(e)}removeStateChangeListener(e){const t=this.stateChangeListeners.indexOf(e);t>-1&&this.stateChangeListeners.splice(t,1)}addErrorListener(e){this.errorListeners.push(e)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}debugLogState(e){console.log(`youtube player state : ${T(e.data)}`)}setUnityGameObjectName(e){this.unityGameObjectName=e,console.log(`Unity GameObject名を設定: ${e}`)}sendStateChangeToUnity(e){if(!this.unityGameObjectName){console.warn("Unity GameObject名が設定されていないため、状態変更を送信できません");return}try{const t=window.webUnityInstance||window.unityInstance;t?(t.SendMessage(this.unityGameObjectName,"OnYouTubeStateChange",e.toString()),console.log(`Unity側に状態変更を送信: ${T(e)}`)):console.warn("Unity インスタンスが見つかりません（webUnityInstance または unityInstance）")}catch(t){console.error("Unity SendMessage送信エラー:",t)}}}const a=new P;class S{constructor(){this.player=null,this.isPlayerReady=!1,this.isVideoLoaded=!1,this.playerReadyPromiseResolver=null,this.playerReadyPromise=new Promise(e=>{this.playerReadyPromiseResolver=e})}initializeAPI(){const e=document.createElement("script");e.src="https://www.youtube.com/iframe_api";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}initializePlayer(){this.player=new YT.Player("player",{height:n.PLAYER_HEIGHT.toString(),width:n.PLAYER_WIDTH.toString(),playerVars:{autoplay:0,playsinline:1,controls:0,disablekb:1,modestbranding:1,fs:0,iv_load_policy:3},events:{onReady:e=>{this.isPlayerReady||(console.log("YouTube Player の準備が完了しました"),this.isPlayerReady=!0,this.playerReadyPromiseResolver())},onStateChange:e=>a.dispatchStateChange(e),onError:e=>a.dispatchError(e)}}),a.addStateChangeListener(e=>a.debugLogState(e))}checkPlayerReady(){return this.player?this.isVideoLoaded?{status:i.SUCCESS}:{status:i.ERROR,message:"動画が読み込まれていません"}:{status:i.ERROR,message:"プレイヤーが初期化されていません"}}play(){const e=this.checkPlayerReady();return e.status!==i.SUCCESS||(this.player.playVideo(),console.log("動画再生を開始しました")),JSON.stringify(e)}pause(){const e=this.checkPlayerReady();return e.status!==i.SUCCESS||(this.player.pauseVideo(),console.log("動画を一時停止しました")),JSON.stringify(e)}stop(){const e=this.checkPlayerReady();return e.status!==i.SUCCESS||(this.player.stopVideo(),console.log("動画を停止しました")),JSON.stringify(e)}seekTo(e){const t=this.checkPlayerReady();if(t.status!==i.SUCCESS)return JSON.stringify(t);const s=parseFloat(e);return isNaN(s)?JSON.stringify({status:i.ERROR,message:`無効な秒数値です: ${e}`}):(this.player.seekTo(s,!0),console.log(`${s}秒の位置にシークしました`),JSON.stringify(t))}getCurrentTime(){return this.checkPlayerReady().status!==i.SUCCESS?n.ERROR_RETURN_VALUE:this.player.getCurrentTime()}getMaxTime(){return this.checkPlayerReady().status!==i.SUCCESS?n.ERROR_RETURN_VALUE:this.player.getDuration()}async loadVideoAsync(e,t=n.DEFAULT_TIMEOUT){return new Promise((s,h)=>{let c=null,r,p;if(!this.player)return h(new Error("YouTube Player が初期化されていません"));const d=()=>{console.log("イベントリスナーをクリーンアップします"),clearTimeout(c),r&&a.removeStateChangeListener(r),p&&a.removeErrorListener(p)};r=y=>{(y.data===YT.PlayerState.PLAYING||y.data===YT.PlayerState.UNSTARTED)&&(console.log("動画読み込み完了を検出しました。Promiseを解決します"),d(),s())},p=y=>{const g=y.data,E=m(g);console.error(`YouTube APIエラーを検出しました: ${E}`),d(),h(new Error(`YouTube Player エラー: ${E} (コード: ${g})`))},c=setTimeout(()=>{const y=`動画読み込みがタイムアウトしました（動画ID: ${e}）`;console.error(y),d(),h(new Error(y))},t),a.addStateChangeListener(r),a.addErrorListener(p),console.log(`YouTube動画を読み込み中... (動画ID: "${e}")`),this.player.cueVideoById(e)})}async loadVideo(e){if(!e||e.trim()==="")return console.error("無効な動画IDが渡されました"),JSON.stringify({status:i.ERROR,message:"動画IDが空です"});this.isVideoLoaded=!1;try{return console.log("YouTube動画を非同期で読み込み中..."),await this.playerReadyPromise,await this.loadVideoAsync(e),this.isVideoLoaded=!0,console.log("動画読み込みと再生準備が完了しました！"),JSON.stringify({status:i.SUCCESS})}catch(t){return console.error("動画読み込みに失敗しました:",t.message),JSON.stringify({status:i.ERROR,message:t.message})}}}const l=new S;class f{constructor(){this.videoContainer=null,this.initialized=!1}init(){this.initialized||(this.videoContainer=document.getElementById("video-container"),this.setupAnimationConfig(),this.setupResizeListener(),this.setupAspectRatio(),this.initialized=!0)}setupAnimationConfig(){const e=document.documentElement,t=n.ANIMATION;e.style.setProperty("--popup-duration",`${t.POPUP_DURATION}ms`),e.style.setProperty("--transition-duration",`${t.TRANSITION_DURATION}ms`),e.style.setProperty("--popup-scale-start",t.POPUP_SCALE_START),e.style.setProperty("--centered-size-ratio",t.CENTERED_SIZE_RATIO),e.style.setProperty("--easing-popup",t.EASING_POPUP),e.style.setProperty("--easing-transition",t.EASING_TRANSITION),console.log("アニメーション設定をCSS変数に適用しました")}setupResizeListener(){window.addEventListener("resize",()=>{this.setupAspectRatio(),this.videoContainer&&this.videoContainer.style.display==="block"&&this.adjustVideoHeight()})}setupAspectRatio(){const e=document.getElementById("unity-container");if(!e)return;const t=window.innerWidth,s=window.innerHeight,h=n.ASPECT_RATIO.WIDTH/n.ASPECT_RATIO.HEIGHT;let c,r;t/s>h?(r=s,c=s*h):(c=t,r=t/h),[e,this.videoContainer].filter(Boolean).forEach(d=>{d.style.width=`${c}px`,d.style.height=`${r}px`,d.style.left=`${(t-c)/2}px`,d.style.top=`${(s-r)/2}px`}),n.UNITY_CONTAINER_MAX_WIDTH=c,console.log(`アスペクト比固定: ${c}x${r}`)}showPlayer(){this.videoContainer&&(this.adjustVideoHeight(),console.log("ビデオプレイヤーを表示"),this.videoContainer.style.display="block")}showFullscreenPlayer(){this.videoContainer&&(this.videoContainer.className="video-fullscreen",this.videoContainer.style.display="block",console.log("YouTubeプレイヤーをフルスクリーン表示"))}shrinkAndMoveToTop(){this.videoContainer&&(this.videoContainer.className="video-minimized",console.log("YouTubeプレイヤーを縮小・上移動"))}showPopupAnimation(){if(this.videoContainer){const e=t=>{t.target===this.videoContainer&&(this.completePopupAnimation(),this.videoContainer.removeEventListener("transitionend",e))};this.videoContainer.addEventListener("transitionend",e),this.videoContainer.className="video-popup-start",this.videoContainer.style.display="block",this.videoContainer.offsetHeight,setTimeout(()=>{this.videoContainer?.classList.contains("video-popup-animate")&&(console.warn("transitionend未発火のためフォールバック実行"),this.completePopupAnimation(),this.videoContainer.removeEventListener("transitionend",e))},n.ANIMATION.POPUP_DURATION+100),this.videoContainer.className="video-centered video-popup-animate",console.log("YouTubeプレイヤーポップアップアニメーション開始（中央配置）")}}completePopupAnimation(){this.videoContainer&&(this.videoContainer.className="video-centered",console.log("ポップアップアニメーション完了（中央配置固定）"))}hidePlayer(){this.videoContainer&&(console.log("ビデオプレイヤーを非表示"),this.videoContainer.style.display="none")}adjustVideoHeight(){const e=n.UNITY_CONTAINER_MAX_WIDTH||window.innerWidth,t=window.innerHeight*n.VIDEO_HEIGHT_RATIO;document.documentElement.style.setProperty("--video-width",`${e}px`),document.documentElement.style.setProperty("--video-height",`${t}px`),console.log(`YouTubeプレイヤーサイズ: ${e}px x ${t}px`)}}const u=new f;u.init(),l.initializeAPI(),window.loadVideo=async function(o,e){return e&&a.setUnityGameObjectName(e),await l.loadVideo(o)},window.playVideo=function(){const o=l.play();return u.showPlayer(),o},window.pauseVideo=function(){return l.pause()},window.stopVideo=function(){return l.stop()},window.seekTo=function(o){return l.seekTo(o)},window.showPlayer=function(){u.showPlayer()},window.hidePlayer=function(){u.hidePlayer()},window.showFullscreenPlayer=function(){u.showFullscreenPlayer()},window.shrinkAndMoveToTop=function(){u.shrinkAndMoveToTop()},window.showPopupAnimation=function(){u.showPopupAnimation()},window.getVideoCurrentTime=function(){return l.getCurrentTime()},window.getVideoMaxTime=function(){return l.getMaxTime()},window.onYouTubeIframeAPIReady=function(){console.log("YouTube IFrame API の準備が完了しました"),l.initializePlayer()}})();
